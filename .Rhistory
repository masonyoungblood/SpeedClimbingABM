setwd("~/Downloads/dataverse_files")
data <- read.csv("rabbit_data.csv")
#load libraries
library(MCMCglmm)
library(rptR)
#re-code open_retr as binary
data$open_retr[!is.na(data$open_retr)] <- 1
data$open_retr[is.na(data$open_retr)] <- 0
#convert data to long format
ind <- c()
expl <- c()
laten <- c()
month <- c()
open_retr <- c()
labyr_exit <- c()
labyr_retr <- c()
sex <- c()
for(i in 1:nrow(data)){
ind <- c(ind, rep(as.character(data$ind[i]), 2))
expl <- c(expl, data$expl_1[i], data$expl_2[i])
laten <- c(laten, data$laten_1[i], data$laten_2[i])
month <- c(month, 1, 2)
open_retr <- c(open_retr, rep(data$open_retr[i], 2))
labyr_exit <- c(labyr_exit, rep(data$labyr_exit[i], 2))
labyr_retr <- c(labyr_retr, rep(data$labyr_retr[i], 2))
sex <- c(sex, rep(data$sex[i], 2))
}
#scale long variables
expl <- scale(expl)
laten <- scale(laten)
labyr_exit <- scale(labyr_exit)
labyr_retr <- scale(labyr_retr)
#convert to data frame
long_data <- data.frame(ind, sex, expl, laten, month, open_retr, labyr_exit, labyr_retr)
long_data$ind <- as.character(long_data$ind)
#scale the original data for sex differences in cognitive traits
data$expl_1 <- scale(data$expl_1)
data$expl_2 <- scale(data$expl_2)
data$laten_1 <- scale(data$laten_1)
data$laten_2 <- scale(data$laten_2)
data$labyr_exit <- scale(data$labyr_exit)
data$labyr_retr <- scale(data$labyr_retr)
expl
long_data$expl
hist(long_data$expl)
hist(long_data$laten)
hist(long_data$laten, breaks = 10)
hist(long_data$laten, breaks = 20)
#load data sheet
data <- read.csv("rabbit_data.csv")
#load libraries
library(MCMCglmm)
library(rptR)
#re-code open_retr as binary
data$open_retr[!is.na(data$open_retr)] <- 1
data$open_retr[is.na(data$open_retr)] <- 0
#convert data to long format
ind <- c()
expl <- c()
laten <- c()
month <- c()
open_retr <- c()
labyr_exit <- c()
labyr_retr <- c()
sex <- c()
for(i in 1:nrow(data)){
ind <- c(ind, rep(as.character(data$ind[i]), 2))
expl <- c(expl, data$expl_1[i], data$expl_2[i])
laten <- c(laten, data$laten_1[i], data$laten_2[i])
month <- c(month, 1, 2)
open_retr <- c(open_retr, rep(data$open_retr[i], 2))
labyr_exit <- c(labyr_exit, rep(data$labyr_exit[i], 2))
labyr_retr <- c(labyr_retr, rep(data$labyr_retr[i], 2))
sex <- c(sex, rep(data$sex[i], 2))
}
expl
hist(expl)
hist(laten)
laten
log(laten)
hist(log(laten))
laten
plot(laten)
hist(laten, breaks = 10)
open_retr
hist(labyr_exit)
labyr_retr
hist(labyr_retr)
log(labyr_retr)
hist(log(labyr_retr))
hist(log(labyr_exit))
hist(log(labyr_exit), breaks = 100)
hist(log(labyr_exit), breaks = 10)
hist(log(labyr_retr), breaks = 10)
#load data sheet
data <- read.csv("rabbit_data.csv")
#load libraries
library(MCMCglmm)
library(rptR)
#re-code open_retr as binary
data$open_retr[!is.na(data$open_retr)] <- 1
data$open_retr[is.na(data$open_retr)] <- 0
#convert data to long format
ind <- c()
expl <- c()
laten <- c()
month <- c()
open_retr <- c()
labyr_exit <- c()
labyr_retr <- c()
sex <- c()
for(i in 1:nrow(data)){
ind <- c(ind, rep(as.character(data$ind[i]), 2))
expl <- c(expl, data$expl_1[i], data$expl_2[i])
laten <- c(laten, data$laten_1[i], data$laten_2[i])
month <- c(month, 1, 2)
open_retr <- c(open_retr, rep(data$open_retr[i], 2))
labyr_exit <- c(labyr_exit, rep(data$labyr_exit[i], 2))
labyr_retr <- c(labyr_retr, rep(data$labyr_retr[i], 2))
sex <- c(sex, rep(data$sex[i], 2))
}
#scale long variables
expl <- scale(expl)
laten <- scale(laten)
labyr_exit <- scale(labyr_exit)
labyr_retr <- scale(labyr_retr)
#convert to data frame
long_data <- data.frame(ind, sex, expl, laten, month, open_retr, labyr_exit, labyr_retr)
long_data$ind <- as.character(long_data$ind)
#scale the original data for sex differences in cognitive traits
data$expl_1 <- scale(data$expl_1)
data$expl_2 <- scale(data$expl_2)
data$laten_1 <- scale(data$laten_1)
data$laten_2 <- scale(data$laten_2)
data$labyr_exit <- scale(data$labyr_exit)
data$labyr_retr <- scale(data$labyr_retr)
#run bivariate analysis with expl and laten as outcome variables, month, sex, open_retr, labyr_exit, and labyr_retr as fixed effects, and ind as random effect, with inverse gamma priors
biv_ig_prior <- list(R = list(V = diag(2), nu = 1.002),
G = list(G1 = list(V = diag(2), nu = 1.002)))
hist(expl)
hist(laten)
biv_for_eff <- MCMCglmm(cbind(expl, log(laten)) ~ trait - 1 + trait:scale(month, scale = FALSE) + trait:scale(sex, scale = FALSE) + trait:scale(open_retr, scale = FALSE) + trait:labyr_exit + trait:labyr_retr,
random = ~ us(trait):ind,
rcov = ~ us(trait):units,
data = long_data,
family = c("gaussian", "gaussian"),
burnin = 1000, nitt = 100000, thin = 10,
prior = biv_ig_prior)
sumary(biv_for_eff)
summary(biv_for_eff)
biv_for_eff <- MCMCglmm(cbind(expl, laten) ~ trait - 1 + trait:scale(month, scale = FALSE) + trait:scale(sex, scale = FALSE) + trait:scale(open_retr, scale = FALSE) + trait:labyr_exit + trait:labyr_retr,
random = ~ us(trait):ind,
rcov = ~ us(trait):units,
data = long_data,
family = c("gaussian", "gaussian"),
burnin = 1000, nitt = 100000, thin = 10,
prior = biv_ig_prior)
biv_for_eff
biv_for_eff <- MCMCglmm(cbind(expl, laten) ~ trait - 1 + trait:scale(month, scale = FALSE) + trait:scale(sex, scale = FALSE) + trait:scale(open_retr, scale = FALSE) + trait:labyr_exit + trait:labyr_retr,
random = ~ us(trait):ind,
rcov = ~ us(trait):units,
data = long_data,
family = c("gaussian", "gaussian"),
burnin = 1000, nitt = 100000, thin = 10,
prior = biv_ig_prior)
summary(biv_for_eff)
?rptGaussian
#run bivariate analysis with expl and laten as outcome variables, month, sex, open_retr, labyr_exit, and labyr_retr as fixed effects, and ind as random effect, with inverse gamma priors
biv_ig_prior <- list(R = list(V = diag(2), nu = 1.002),
G = list(G1 = list(V = diag(2), nu = 1.002)))
biv_for_eff <- MCMCglmm(cbind(expl, log(laten)) ~ trait - 1 + trait:scale(month, scale = FALSE) + trait:scale(sex, scale = FALSE) + trait:scale(open_retr, scale = FALSE) + trait:labyr_exit + trait:labyr_retr,
random = ~ us(trait):ind,
rcov = ~ us(trait):units,
data = long_data,
family = c("gaussian", "gaussian"),
burnin = 1000, nitt = 100000, thin = 10,
prior = biv_ig_prior)
#run bivariate analysis with expl and laten as outcome variables, month, sex, open_retr, labyr_exit, and labyr_retr as fixed effects, and ind as random effect, with inverse gamma priors
biv_ig_prior <- list(R = list(V = diag(2), nu = 1.002),
G = list(G1 = list(V = diag(2), nu = 1.002)))
biv_for_eff <- MCMCglmm(cbind(expl, scale(log(laten))) ~ trait - 1 + trait:scale(month, scale = FALSE) + trait:scale(sex, scale = FALSE) + trait:scale(open_retr, scale = FALSE) + trait:labyr_exit + trait:labyr_retr,
random = ~ us(trait):ind,
rcov = ~ us(trait):units,
data = long_data,
family = c("gaussian", "gaussian"),
burnin = 1000, nitt = 100000, thin = 10,
prior = biv_ig_prior)
summary(biv_for_eff)
laten_rpt <- rptGaussian(log(laten) ~ (1 | ind), data = long_data, grname = "ind", nboot = 10000, npermut = 100000)
BBmisc::normalize(c(1, 2, 3, 4, 5), "range", c(-1, 1))
BBmisc::normalize(c(1, 2, 3, 4, 5), "range", c(-1, 1))
BBmisc::normalize(c(1, 2, 3, 4, 5), "range", c(-1, 1))
BBmisc::normalize(c(1, 2, 3, 4, 5), "range", c(-1, 1))
learn_x_times = 0
learn_x_pop = 0
innov_x_times = 0
innov_x_pop = 0
learn_x_pop > 0 & learn_x_pop > 0
#set working directory, load data, source code
setwd("~/Documents/Work/Summer_2021/Speed Climbing/SpeedClimbingABM") #local test
#setwd(system("pwd", intern = T))
load("data.RData")
source("SpeedClimbingABM.R")
#random seed
set.seed(12345)
#get all unique climbers
uniq_climbers <- unique(data$athlete)
#separate continuous sequences of years
seqs <- lapply(uniq_climbers, function(x){split(data$year[which(data$athlete == x)], cumsum(seq_along(data$year[which(data$athlete == x)]) %in% (which(diff(data$year[which(data$athlete == x)]) > 1) + 1)))})
#for each unique climber, iterate through their sequences, and and extract their ID, start year, end year, and time in start year (separate row per sequence)
pop_data <- data.table::data.table(do.call(rbind, lapply(1:length(uniq_climbers), function(i){
t(sapply(1:length(seqs[[i]]), function(j){
c(uniq_climbers[i], min(unlist(seqs[[i]][j])), max(unlist(seqs[[i]][j])), data$time[which(data$athlete == uniq_climbers[i] & data$year == min(unlist(seqs[[i]][j])))])
}))
})))
colnames(pop_data) <- c("ID", "start", "end", "time")
pop_data
#subset both data objects to only include men
pop_data <- pop_data[which(data$gender[match(pop_data$ID, data$athlete)] == "M"), ]
data <- data[which(data$gender == "M"), ]
#get years
years <- sort(unique(data$year))
#get population sizes
n <- unlist(lapply(1:length(years), function(x){nrow(data[which(data$year == years[x]), ])}))
#wrap SpeedClimbingABM in a simpler function for slurm
SpeedClimbingABM_slurm <- function(innov_prob, learn_prob, n_top, adj_poss, improve_rate_m, improve_rate_sd, improve_min){
c(SpeedClimbingABM(n = n, years = years, pop_data = pop_data, n_holds = 20,
beta_true_prob = 1, innov_prob = innov_prob, learn_prob = learn_prob, n_top = n_top, adj_poss = adj_poss,
improve_rate_m = improve_rate_m, improve_rate_sd = improve_rate_sd, improve_min = improve_min,
sum_stats = TRUE, plot = FALSE))
}
#store required packages
pkgs <- unique(getParseData(parse("SpeedClimbingABM.R"))$text[getParseData(parse("SpeedClimbingABM.R"))$token == "SYMBOL_PACKAGE"])
i <- 1
n_sim <- 100 #local test
#n_sim <- 10000000
#set priors
priors <- data.frame(innov_prob = truncnorm::rtruncnorm(n_sim, a = 0, b = 0.5, mean = 0, sd = 0.1),
learn_prob = truncnorm::rtruncnorm(n_sim, a = 0, b = 0.5, mean = 0, sd = 0.1),
n_top = runif(n_sim, min = 1, max = 34),
adj_poss = runif(n_sim, 1, 2),
improve_rate_m = runif(n_sim, min = 1, max = 4),
improve_rate_sd = truncnorm::rtruncnorm(n_sim, a = 0, mean = 0, sd = 2),
improve_min = runif(n_sim, min = 0, max = 0.5))
SpeedClimbingABM_slurm(priors[1,])
priors[1,]
c(priors[1,])
as.numeric(priors[1,])
SpeedClimbingABM_slurm(as.numeric(priors[1,]))
SpeedClimbingABM_slurm(0, 0, 5, 2, 2, 0.1, 0.3)
SpeedClimbingABM_slurm(0, 0, 5, 2, 2, 0.1, 0.3)
SpeedClimbingABM_slurm(0, 0, 5, 2, 2, 0.1, 0.3)
SpeedClimbingABM_slurm(0, 0, 5, 2, 2, 0.1, 0.3)
SpeedClimbingABM_slurm(as.numeric(priors[1,]))
SpeedClimbingABM(n = n, years = years, pop_data = pop_data, n_holds = 20,
beta_true_prob = 1, innov_prob = innov_prob, learn_prob = learn_prob, n_top = n_top, adj_poss = adj_poss,
improve_rate_m = improve_rate_m, improve_rate_sd = improve_rate_sd, improve_min = improve_min,
sum_stats = TRUE, plot = FALSE)
#wrap SpeedClimbingABM in a simpler function for slurm
SpeedClimbingABM_slurm <- function(innov_prob, learn_prob, n_top, adj_poss, improve_rate_m, improve_rate_sd, improve_min){
SpeedClimbingABM(n = n, years = years, pop_data = pop_data, n_holds = 20,
beta_true_prob = 1, innov_prob = innov_prob, learn_prob = learn_prob, n_top = n_top, adj_poss = adj_poss,
improve_rate_m = improve_rate_m, improve_rate_sd = improve_rate_sd, improve_min = improve_min,
sum_stats = TRUE, plot = FALSE)
}
SpeedClimbingABM_slurm(0, 0, 5, 2, 2, 0.1, 0.3)
#wrap SpeedClimbingABM in a simpler function for slurm
SpeedClimbingABM_slurm <- function(innov_prob, learn_prob, n_top, adj_poss, improve_rate_m, improve_rate_sd, improve_min){
#wrap SpeedClimbingABM in a simpler function for slurm
SpeedClimbingABM_slurm <- function(innov_prob, learn_prob, n_top, adj_poss, improve_rate_m, improve_rate_sd, improve_min){
#wrap SpeedClimbingABM in a simpler function for slurm
SpeedClimbingABM_slurm <- function(innov_prob, learn_prob, n_top, adj_poss, improve_rate_m, improve_rate_sd, improve_min){
c(t(SpeedClimbingABM(n = n, years = years, pop_data = pop_data, n_holds = 20,
beta_true_prob = 1, innov_prob = innov_prob, learn_prob = learn_prob, n_top = n_top, adj_poss = adj_poss,
improve_rate_m = improve_rate_m, improve_rate_sd = improve_rate_sd, improve_min = improve_min,
sum_stats = TRUE, plot = FALSE)))
}
)
#wrap SpeedClimbingABM in a simpler function for slurm
SpeedClimbingABM_slurm <- function(innov_prob, learn_prob, n_top, adj_poss, improve_rate_m, improve_rate_sd, improve_min){
c(t(SpeedClimbingABM(n = n, years = years, pop_data = pop_data, n_holds = 20,
beta_true_prob = 1, innov_prob = innov_prob, learn_prob = learn_prob, n_top = n_top, adj_poss = adj_poss,
improve_rate_m = improve_rate_m, improve_rate_sd = improve_rate_sd, improve_min = improve_min,
sum_stats = TRUE, plot = FALSE)))
}
SpeedClimbingABM_slurm(0, 0, 5, 2, 2, 0.1, 0.3)
#set working directory, load data, source code
setwd("~/Documents/Work/Summer_2021/Speed Climbing/SpeedClimbingABM") #local test
#setwd(system("pwd", intern = T))
load("data.RData")
source("SpeedClimbingABM.R")
#random seed
set.seed(12345)
#get all unique climbers
uniq_climbers <- unique(data$athlete)
#separate continuous sequences of years
seqs <- lapply(uniq_climbers, function(x){split(data$year[which(data$athlete == x)], cumsum(seq_along(data$year[which(data$athlete == x)]) %in% (which(diff(data$year[which(data$athlete == x)]) > 1) + 1)))})
#for each unique climber, iterate through their sequences, and and extract their ID, start year, end year, and time in start year (separate row per sequence)
pop_data <- data.table::data.table(do.call(rbind, lapply(1:length(uniq_climbers), function(i){
t(sapply(1:length(seqs[[i]]), function(j){
c(uniq_climbers[i], min(unlist(seqs[[i]][j])), max(unlist(seqs[[i]][j])), data$time[which(data$athlete == uniq_climbers[i] & data$year == min(unlist(seqs[[i]][j])))])
}))
})))
colnames(pop_data) <- c("ID", "start", "end", "time")
pop_data
#subset both data objects to only include men
pop_data <- pop_data[which(data$gender[match(pop_data$ID, data$athlete)] == "M"), ]
data <- data[which(data$gender == "M"), ]
#get years
years <- sort(unique(data$year))
#get population sizes
n <- unlist(lapply(1:length(years), function(x){nrow(data[which(data$year == years[x]), ])}))
#wrap SpeedClimbingABM in a simpler function for slurm
SpeedClimbingABM_slurm <- function(innov_prob, learn_prob, n_top, adj_poss, improve_rate_m, improve_rate_sd, improve_min){
c(t(SpeedClimbingABM(n = n, years = years, pop_data = pop_data, n_holds = 20,
beta_true_prob = 1, innov_prob = innov_prob, learn_prob = learn_prob, n_top = n_top, adj_poss = adj_poss,
improve_rate_m = improve_rate_m, improve_rate_sd = improve_rate_sd, improve_min = improve_min,
sum_stats = TRUE, plot = FALSE)))
}
#store required packages
pkgs <- unique(getParseData(parse("SpeedClimbingABM.R"))$text[getParseData(parse("SpeedClimbingABM.R"))$token == "SYMBOL_PACKAGE"])
i <- 1
#number of simulations
n_sim <- 100 #local test
#n_sim <- 10000000
#set priors
priors <- data.frame(innov_prob = truncnorm::rtruncnorm(n_sim, a = 0, b = 0.5, mean = 0, sd = 0.1),
learn_prob = truncnorm::rtruncnorm(n_sim, a = 0, b = 0.5, mean = 0, sd = 0.1),
n_top = runif(n_sim, min = 1, max = 34),
adj_poss = runif(n_sim, 1, 2),
improve_rate_m = runif(n_sim, min = 1, max = 4),
improve_rate_sd = truncnorm::rtruncnorm(n_sim, a = 0, mean = 0, sd = 2),
improve_min = runif(n_sim, min = 0, max = 0.5))
#run simulations
slurm <- rslurm::slurm_apply(SpeedClimbingABM_slurm, priors, jobname = "main", pkgs = pkgs, global_objects = objects(), submit = FALSE) #local test
#slurm <- rslurm::slurm_apply(SpeedClimbingABM_slurm, priors, jobname = "main",
#                             nodes = 4, cpus_per_node = 48, pkgs = pkgs, global_objects = objects())
slurm <- rslurm::local_slurm_array(slurm) #local test
#get output and clean files
sum_stats <- rslurm::get_slurm_out(slurm)
rslurm::cleanup_files(slurm)
sum_stats
?rslurm::slurm_apply
?get_slurm_out
#run simulations
slurm <- rslurm::slurm_apply(SpeedClimbingABM_slurm, priors, jobname = "main", pkgs = pkgs, global_objects = objects(), submit = FALSE) #local test
#slurm <- rslurm::slurm_apply(SpeedClimbingABM_slurm, priors, jobname = "main",
#                             nodes = 4, cpus_per_node = 48, pkgs = pkgs, global_objects = objects())
slurm <- rslurm::local_slurm_array(slurm) #local test
#get output and clean files
sum_stats <- rslurm::get_slurm_out(slurm, outtype = "table")
sum_stats
sum_stats$V12
sum_stats$V11
sum_stats$V10
sum_stats$V12
sum_stats$V13
sum_stats$V14
sum_stats$V15
rslurm::cleanup_files(slurm)
sum_stats
#set working directory, load data, source code
setwd("~/Documents/Work/Summer_2021/Speed Climbing/SpeedClimbingABM") #local test
#setwd(system("pwd", intern = T))
load("data.RData")
source("SpeedClimbingABM.R")
#random seed
set.seed(12345)
#get all unique climbers
uniq_climbers <- unique(data$athlete)
#separate continuous sequences of years
seqs <- lapply(uniq_climbers, function(x){split(data$year[which(data$athlete == x)], cumsum(seq_along(data$year[which(data$athlete == x)]) %in% (which(diff(data$year[which(data$athlete == x)]) > 1) + 1)))})
#for each unique climber, iterate through their sequences, and and extract their ID, start year, end year, and time in start year (separate row per sequence)
pop_data <- data.table::data.table(do.call(rbind, lapply(1:length(uniq_climbers), function(i){
t(sapply(1:length(seqs[[i]]), function(j){
c(uniq_climbers[i], min(unlist(seqs[[i]][j])), max(unlist(seqs[[i]][j])), data$time[which(data$athlete == uniq_climbers[i] & data$year == min(unlist(seqs[[i]][j])))])
}))
})))
colnames(pop_data) <- c("ID", "start", "end", "time")
pop_data
#subset both data objects to only include men
pop_data <- pop_data[which(data$gender[match(pop_data$ID, data$athlete)] == "M"), ]
data <- data[which(data$gender == "M"), ]
#get years
years <- sort(unique(data$year))
#get population sizes
n <- unlist(lapply(1:length(years), function(x){nrow(data[which(data$year == years[x]), ])}))
#wrap SpeedClimbingABM in a simpler function for slurm
SpeedClimbingABM_slurm <- function(innov_prob, learn_prob, n_top, adj_poss, improve_rate_m, improve_rate_sd, improve_min){
c(t(SpeedClimbingABM(n = n, years = years, pop_data = pop_data, n_holds = 20,
beta_true_prob = 1, innov_prob = innov_prob, learn_prob = learn_prob, n_top = n_top, adj_poss = adj_poss,
improve_rate_m = improve_rate_m, improve_rate_sd = improve_rate_sd, improve_min = improve_min,
sum_stats = TRUE, plot = FALSE)))
}
#store required packages
pkgs <- unique(getParseData(parse("SpeedClimbingABM.R"))$text[getParseData(parse("SpeedClimbingABM.R"))$token == "SYMBOL_PACKAGE"])
#run simulations,
for(i in 1:5){
#number of simulations
n_sim <- 100 #local test
#n_sim <- 10000000
#set priors
priors <- data.frame(innov_prob = truncnorm::rtruncnorm(n_sim, a = 0, b = 0.5, mean = 0, sd = 0.1),
learn_prob = truncnorm::rtruncnorm(n_sim, a = 0, b = 0.5, mean = 0, sd = 0.1),
n_top = runif(n_sim, min = 1, max = 34),
adj_poss = runif(n_sim, 1, 2),
improve_rate_m = runif(n_sim, min = 1, max = 4),
improve_rate_sd = truncnorm::rtruncnorm(n_sim, a = 0, mean = 0, sd = 2),
improve_min = runif(n_sim, min = 0, max = 0.5))
#run simulations
slurm <- rslurm::slurm_apply(SpeedClimbingABM_slurm, priors, jobname = "main", pkgs = pkgs, global_objects = objects(), submit = FALSE) #local test
#slurm <- rslurm::slurm_apply(SpeedClimbingABM_slurm, priors, jobname = "main",
#                             nodes = 4, cpus_per_node = 48, pkgs = pkgs, global_objects = objects())
slurm <- rslurm::local_slurm_array(slurm) #local test
#get output and clean files
sum_stats <- rslurm::get_slurm_out(slurm, outtype = "table")
rslurm::cleanup_files(slurm)
#save output
simulations <- list(priors = priors, sum_stats = sum_stats)
save(simulations, file = paste0("simulations_m_", i, ".RData"))
#remove temporary objects
rm(list = c("priors", "slurm", "sum_stats", "simulations"))
}
load("/Users/masonyoungblood/Documents/Work/Summer_2021/Speed Climbing/SpeedClimbingABM/simulations_m_2.RData")
simulations
